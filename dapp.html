<script src='https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js'></script>

<script>
// Contract Info
const network = 'rinkeby'
const ERC721ADDRESS = '0xe0EFd5DE2F4C041BBc3559e4557fD8824Ea1139A'
const ERC721ABI = [{"anonymous":false,"inputs":[{"indexed":false,"internalType":"int256","name":"old","type":"int256"},{"indexed":false,"internalType":"int256","name":"current","type":"int256"}],"name":"BTCETHPriceUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"int256","name":"old","type":"int256"},{"indexed":false,"internalType":"int256","name":"current","type":"int256"}],"name":"BTCETHPriceUpdated","type":"event"},{"inputs":[],"name":"getBitcoinPriceInWei","outputs":[{"internalType":"int256","name":"","type":"int256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"publicSaleStart_timestampInS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"purchase","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bytes","name":"_data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}]

</script>

<script>
console.log('Script started')

const ethSymbol = 'Œû'

// Placeholder values
let maxSupply = 10000
let totalSupply = 0
let buyPrice = 0.0001
let walletAddress = 0
let addresses = 0
let metamaskInstalled = false
let Erc721Instance

const numberWithCommas = (x) => x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',')
const isMobile = () => /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)

const onLoadHandler = () => {
  console.log('Loading window')

  const walletButton = document.querySelector('#walletButton')
  const balanceLabel = document.querySelector('#balanceLabel')
  const priceLabel = document.querySelector('#priceLabel')
  const pizzasLabel = document.querySelector('#pizzasLabel')
  const buyButton = document.querySelector('#buyButton')
  const contractLabel = document.querySelector('#contractLabel')
  const txLabel = document.querySelector('#txLabel')

  // Placeholders
  balanceLabel.innerHTML = '--' + ' ' + ethSymbol
  priceLabel.innerHTML = '--' + ' ' + ethSymbol
  pizzasLabel.innerHTML = '--'
  contractLabel.innerHTML = 'Contract Address: ' + ERC721ADDRESS || 0

  const promptMetamask = () => {
    window.ethereum.enable()
      .then(async () => {
        await updateBalance()
      }).catch((err) => {
      console.log(err)
    })
  }

  const triggerPurchase = () => {
    txLabel.innerHTML = 'Waiting for confirmation'
    var txHash = 0
    Erc721Instance.methods.getPrice().call()
      .then((amount) => {
        console.log('priceWei: ', amount)

        Erc721Instance.methods.purchase().send({from: walletAddress, value: amount})
          .on('transactionHash', (hash) => {
            console.log('transactionHash: ', hash)
            txHash = hash
          })
          .on('receipt', (receipt) => {
            console.log('receipt: ', receipt)

            txLabel.innerHTML = "Transaction confirmed, enjoy your üçï! <p> " +
              "<a href='https://" + network + ".etherscan.io/tx/" +
              txHash + "' target='_blank'> Transaction link </a>"

            updateValues()
          })
          .on('error', (err, receipt) => {
            console.log('Transaction failed: ', err, 'br/', receipt)

            txLabel.innerHTML = 'Something went wrong, try again!'
          })
      })
      .catch((_) => {
        console.log('getPrice failed')

        txLabel.innerHTML = 'Something went wrong, try again!'
      })
  }

  const updateValues = () => {
    Erc721Instance.methods.getPrice().call()
      .then((amount) => {
        buyPrice = web3.utils.fromWei(amount)

        console.log('Price: ', buyPrice)

        priceLabel.innerHTML = buyPrice + ' ' + ethSymbol
      })
      .catch((_) => {
        console.log('getPrice failed')
      })

    Erc721Instance.methods.maxSupply().call()
      .then((amount) => {
        maxSupply = amount

        console.log('maxSupply: ', amount)

        pizzasLabel.innerHTML = numberWithCommas(maxSupply - totalSupply)
      })
      .catch((_) => {
        console.log('maxSupply failed')
      })

    Erc721Instance.methods.totalSupply().call()
      .then((amount) => {
        totalSupply = amount

        console.log('totalSupply: ', amount)

        pizzasLabel.innerHTML = numberWithCommas(maxSupply - totalSupply)
      })
      .catch((_) => {
        console.log('totalSupply failed')
      })
  }

  const handleUser = () => {
    web3.eth.getAccounts()
      .then(async (accounts) => {
        addresses = accounts

        console.log('accounts: ', accounts)

        if (!accounts.length) {
          console.log('User is logged out')
        } else {
          console.log('User is logged in')

          await updateBalance()
        }
      }).catch((err) => {
      console.log('Error fetching accounts: ', err)
    })
  }

  const updateBalance = async () => {
    walletAddress = (await web3.eth.getAccounts())[0]

    console.log('Wallet address: ', walletAddress)

    const walletBalance = await web3.eth.getBalance(walletAddress)
    const balance = web3.utils.fromWei(walletBalance)
    const balanceFloat = parseFloat(balance)
    const roundedBalance = balanceFloat.toFixed(4)

    balanceLabel.innerHTML = roundedBalance + ' ' + ethSymbol

    console.log('ETH balance: ', roundedBalance)
  }

  const buyButtonHandler = () => {
    console.log('Buy button pressed')

    handleUser()

    if (!addresses.length) {
      promptMetamask()
    } else {
      triggerPurchase()
    }
  }

  const walletButtonHandler = () => {
    console.log('Wallet button pressed')

    if (metamaskInstalled) {
      promptMetamask()
    } else {
      window.open('https://www.metamask.io')
    }
  }

  const startApp = () => {
    console.log('App started')

    Erc721Instance = new web3.eth.Contract(ERC721ABI,ERC721ADDRESS)

    Erc721Instance.events.Transfer((err, e) => { console.log(e) })
      .on('data', (e) =>{
        console.log('event: ', e)

        updateValues()
        //console.log('eventTokenId: ', event['returnedValues']['tokenId']) // TO-DO: get pizza # from here
      })
      .on('changed', (_) => {
        console.log('changed')
      })
      .on('error', console.error)

    updateValues()
    handleUser()
  }

  const initWeb3 = () => {
    if (window.ethereum) {
      console.log('Window.ethereum exists')

      metamaskInstalled = true
      window.web3 = new Web3(window.ethereum)

      startApp()
    } else if (window.web3) {
      console.log('Window.web3 exists')

      metamaskInstalled = true
      window.web3 = new Web3(window.web3.currentProvider)

      startApp()
    } else if (isMobile) {
      console.log('Mobile initiated')

      metamaskInstalled = true
      startApp()
    } else {
      console.log('Non-ethereum browser detected')

      window.alert('Browser not compatible. Try Chrome and MetaMask!')

      txLabel.innerHTML = 'Try Chrome and MetaMask!'
      metamaskInstalled = false
    }
  }

  initWeb3()

  walletButton.addEventListener('click', walletButtonHandler)
  buyButton.addEventListener('click', buyButtonHandler)
}

window.addEventListener('load', onLoadHandler, { once: true })
</script>
